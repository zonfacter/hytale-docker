#===============================================================================
# Hytale Server + Dashboard - Docker Compose
# https://github.com/zonfacter/hytale-docker
#
# Schnellstart / Quick Start:
#   docker-compose up -d
#
# Dashboard öffnen / Open Dashboard:
#   http://localhost:8088
#
#===============================================================================
# WICHTIG / IMPORTANT: Volume Configuration
#===============================================================================
# Diese Konfiguration verwendet standardmäßig benannte Volumes (named volumes).
# Dies ist die empfohlene Methode für Produktionssysteme, da sie:
# - Unabhängig vom Arbeitsverzeichnis sind
# - Besser von Docker verwaltet werden
# - Konsistent über verschiedene Betriebssysteme hinweg funktionieren
#
# This configuration uses named volumes by default. This is the recommended
# method for production systems because they:
# - Are independent of the working directory
# - Are better managed by Docker
# - Work consistently across different operating systems
#
# Alternative Optionen / Alternative options:
# 1. Bind Mounts mit relativen Pfaden - siehe Zeile 106
#    Bind mounts with relative paths - see line 106
# 2. Bind Mounts mit absoluten Pfaden - siehe Zeile 116
#    Bind mounts with absolute paths - see line 116
#===============================================================================

services:
  hytale:
    image: zonfacter/hytale-docker:latest
    container_name: hytale-server
    build:
      context: .
      dockerfile: Dockerfile
      # Build arguments for customization (optional)
      # Default: Debian Trixie + Java 24 (required for AOTCache)
      # Uncomment and modify to use different base images or Java versions
      # args:
      #   DEBIAN_BASE_IMAGE: debian:trixie-slim
      #   DEBIAN_CODENAME: trixie
      #   JAVA_VERSION: 24

    # Ports
    ports:
      # Dashboard Web-Interface
      - "8088:8088/tcp"
      # Hytale Game Server
      - "5520:5520/udp"
      # Nitrado WebServer API (for plugins)
      - "5523:5523/tcp"

    # Capabilities for Tailscale VPN
    # Required when TAILSCALE_ENABLED=true
    cap_add:
      - NET_ADMIN
      - SYS_MODULE

    # Device for Tailscale VPN
    # Required when TAILSCALE_ENABLED=true
    devices:
      - /dev/net/tun:/dev/net/tun

    # Environment Variables
    environment:
      # Server Settings
      - HYTALE_MEMORY_MIN=2G
      - HYTALE_MEMORY_MAX=4G

      # Downloader Settings
      # URL to automatically download the Hytale downloader (ZIP supported)
      # Default: https://downloader.hytale.com/hytale-downloader.zip
      # Leave empty to use the default URL, or set custom URL
      - HYTALE_DOWNLOADER_URL=https://downloader.hytale.com/hytale-downloader.zip

      # Dashboard Settings
      - DASH_USER=admin
      - DASH_PASS=changeme          # CHANGE THIS!
      - ALLOW_CONTROL=true

      # Optional: CurseForge API Key for mod downloads
      # Get your free key at: https://console.curseforge.com/
      # TIP: Can also be configured later via Dashboard → Setup → Settings
      - CF_API_KEY=

      # Tailscale VPN Settings (Optional)
      # Enable Tailscale for secure remote access without port-forwarding
      # Get auth key at: https://login.tailscale.com/admin/settings/keys
      - TAILSCALE_ENABLED=false
      - TAILSCALE_AUTHKEY=           # Optional: tskey-auth-xxxxx
      - TAILSCALE_HOSTNAME=hytale-server
      - TAILSCALE_ADVERTISE_ROUTES=  # Optional: subnet routing (e.g., 10.0.0.0/24)

      # User/Group IDs (for file permissions)
      - PUID=1000
      - PGID=1000

      # Timezone
      - TZ=Europe/Berlin

    # Persistent Data Volumes
    # Using named volumes (recommended for production and portability)
    # Note: Universe path changed in Hytale Server 2026.01+ to Server/universe/
    volumes:
      # Game world data (players, buildings, etc.)
      - hytale-universe:/opt/hytale-server/Server/universe

      # Installed mods
      - hytale-mods:/opt/hytale-server/mods

      # Backup files
      - hytale-backups:/opt/hytale-server/backups

      # Downloader & credentials (for OAuth)
      - hytale-downloader:/opt/hytale-server/.downloader

      # Logs (optional)
      - hytale-logs:/opt/hytale-server/logs

      # Tailscale state (for VPN persistence)
      - hytale-tailscale:/var/lib/tailscale

      # Docker socket (read-only, for port mapping display in dashboard)
      # This allows the dashboard to show external port mappings in bridge mode
      - /var/run/docker.sock:/var/run/docker.sock:ro

    # Alternative: Bind mounts with relative paths
    # Use this if you need direct host file system access (e.g., for backups or config editing)
    # IMPORTANT: Must run docker-compose from the repository root directory
    # Note: Universe path changed in Hytale Server 2026.01+ to Server/universe/
    # For production, consider using absolute paths instead
    # volumes:
    #   - ./data/universe:/opt/hytale-server/Server/universe
    #   - ./data/mods:/opt/hytale-server/mods
    #   - ./data/backups:/opt/hytale-server/backups
    #   - ./data/downloader:/opt/hytale-server/.downloader
    #   - ./data/config.json:/opt/hytale-server/config.json
    #   - ./data/logs:/opt/hytale-server/logs

    # Alternative: Bind mounts with absolute paths (most reliable for production)
    # Replace /path/to/hytale-data with your actual data directory path
    # Note: Universe path changed in Hytale Server 2026.01+ to Server/universe/
    # volumes:
    #   - /path/to/hytale-data/universe:/opt/hytale-server/Server/universe
    #   - /path/to/hytale-data/mods:/opt/hytale-server/mods
    #   - /path/to/hytale-data/backups:/opt/hytale-server/backups
    #   - /path/to/hytale-data/downloader:/opt/hytale-server/.downloader
    #   - /path/to/hytale-data/config.json:/opt/hytale-server/config.json
    #   - /path/to/hytale-data/logs:/opt/hytale-server/logs

    # Restart Policy
    restart: unless-stopped

    # Resource Limits (optional, adjust as needed)
    # deploy:
    #   resources:
    #     limits:
    #       memory: 6G
    #     reservations:
    #       memory: 4G

    # Stop gracefully (SIGINT for proper save)
    stop_signal: SIGINT
    stop_grace_period: 60s

#===============================================================================
# Named Volumes Definition
#===============================================================================
volumes:
  hytale-universe:
    driver: local
  hytale-mods:
    driver: local
  hytale-backups:
    driver: local
  hytale-downloader:
    driver: local
  hytale-logs:
    driver: local
  hytale-tailscale:
    driver: local
